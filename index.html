<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroSense Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden; /* Prevent body scroll */
        }
        #map {
            height: 100%;
            width: 100%;
            border-radius: 0.5rem; /* rounded-lg */
        }
        .data-card {
            background-color: #ffffff;
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1.5rem; /* p-6 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
        }
        .chart-container {
            position: relative;
            height: 200px; /* Fixed height for charts */
            width: 100%;
        }
        /* Custom styles for NDVI overlay legend */
        .info.legend {
            background: white;
            padding: 8px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .info.legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
            border-radius: 2px; /* Slightly rounded color blocks */
        }
    </style>
</head>
<body class="bg-gray-100 flex h-screen">
    <div class="w-1/4 bg-white p-6 shadow-lg rounded-r-lg flex flex-col justify-between">
        <div>
            <h1 class="text-3xl font-bold text-green-700 mb-6">AgroSense</h1>
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Farm Areas</h2>
            <ul id="farm-list" class="space-y-3">
                </ul>
        </div>
        <div class="text-sm text-gray-500 mt-6">
            <p>&copy; 2025 AgroSense. All rights reserved.</p>
        </div>
    </div>

    <div class="flex-1 p-6 flex flex-col space-y-6 overflow-y-auto">
        <div class="h-1/2 bg-white rounded-lg shadow-md relative">
            <div id="map" class="absolute inset-0"></div>
            <div id="no-farm-selected-overlay" class="absolute inset-0 bg-gray-200 bg-opacity-90 flex items-center justify-center rounded-lg text-gray-600 text-lg font-semibold text-center z-10 hidden">
                Please select a farm area from the map or list to view its details.
            </div>
        </div>

        <div id="dashboard-data" class="h-1/2 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 overflow-y-auto pt-2">
            <div class="md:col-span-2 lg:col-span-3 text-center text-gray-500 text-lg py-10" id="data-placeholder">
                <p>Select a farm to see detailed agricultural insights.</p>
            </div>

            <div id="farm-overview-card" class="data-card hidden">
                <h3 class="text-2xl font-semibold text-green-800 mb-4" id="farm-name">Farm Name</h3>
                <div class="grid grid-cols-1 gap-3 text-gray-700">
                    <div><span class="font-medium">Area:</span> <span id="farm-area"></span></div>
                    <div><span class="font-medium">Location:</span> <span id="farm-location"></span></div>
                    <div><span class="font-medium">Last Update:</span> <span id="last-update"></span></div>
                </div>
            </div>

            <div id="satellite-data-card" class="data-card hidden">
                <h3 class="text-2xl font-semibold text-green-800 mb-4">Satellite Monitoring</h3>
                <div class="chart-container mb-4">
                    <canvas id="ndviChart"></canvas>
                </div>
                <div class="mt-4">
                    <p class="text-sm text-gray-600 mb-2">Vigor (NDVI) & Water Stress (NDMI) over time.</p>
                    <span class="font-medium text-gray-700">Current NDMI:</span> <span id="current-ndmi" class="text-green-600"></span><br>
                    <span class="font-medium text-gray-700">Water Stress Status:</span> <span id="water-stress-status" class="text-yellow-600"></span><br>
                    <span class="font-medium text-gray-700">EVI (Enhanced Veg. Index):</span> <span id="current-evi" class="text-purple-600"></span>
                </div>
                <button id="toggle-ndvi-spatial" class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out text-sm">
                    Show NDVI Map
                </button>
            </div>

            <div id="insitu-weather-data-card" class="data-card hidden">
                <h3 class="text-2xl font-semibold text-green-800 mb-4">In-Situ & Weather</h3>
                <div class="chart-container">
                    <canvas id="soilMoistureChart"></canvas>
                </div>
                <div class="grid grid-cols-2 gap-4 text-gray-700 mt-4">
                    <div><span class="font-medium">Soil pH:</span> <span id="soil-ph" class="font-bold"></span></div>
                    <div><span class="font-medium">Air Temp:</span> <span id="air-temp" class="font-bold"></span></div>
                    <div><span class="font-medium">Humidity:</span> <span id="humidity" class="font-bold"></span></div>
                    <div><span class="font-medium">Last 24h Rain:</span> <span id="last-rain" class="font-bold"></span></div>
                </div>
                <h4 class="text-xl font-semibold text-gray-800 mt-6 mb-3">Weather Forecast</h4>
                <p class="text-gray-700" id="weather-forecast"></p>
            </div>

            <div id="farm-analytics-card" class="data-card hidden">
                <h3 class="text-2xl font-semibold text-green-800 mb-4">Farm Analytics & Forecasts</h3>
                <div class="mb-4">
                    <h4 class="text-lg font-medium text-gray-800 mb-2">Phenology</h4>
                    <p class="text-gray-700"><span class="font-medium">Current Stage:</span> <span id="current-pheno"></span></p>
                    <p class="text-gray-700"><span class="font-medium">Next Stage Est.:</span> <span id="next-pheno"></span></p>
                </div>
                <div class="mb-4">
                    <h4 class="text-lg font-medium text-gray-800 mb-2">Pest & Disease Risk</h4>
                    <p class="text-gray-700"><span class="font-medium">Risk Level:</span> <span id="pest-risk" class="font-bold text-red-600"></span></p>
                    <p class="text-sm text-gray-600" id="pest-advice"></p>
                </div>
                <div>
                    <h4 class="text-lg font-medium text-gray-800 mb-2">Fertilization Needs</h4>
                    <p class="text-gray-700" id="fert-recommendation"></p>
                </div>
            </div>

            <div id="irrigation-status-card" class="data-card hidden">
                <h3 class="text-2xl font-semibold text-green-800 mb-4">Irrigation & System Status</h3>
                <div class="mb-4">
                    <span class="font-medium text-gray-700">Irrigation Needs:</span>
                    <span id="irrigation-needs" class="font-bold text-blue-600 text-lg"></span>
                </div>
                <div class="mb-6">
                    <span class="font-medium text-gray-700">DSS Recommended Action:</span>
                    <span id="recommended-action" class="text-green-700 font-bold"></span>
                </div>

                <h4 class="text-xl font-semibold text-gray-800 mt-6 mb-3">Solar-Powered System Status</h4>
                <ul class="space-y-2 text-gray-700">
                    <li><span class="font-medium">Solar Panels:</span> <span id="solar-panel-status" class="font-bold"></span></li>
                    <li><span class="font-medium">Battery Level:</span> <span id="battery-level" class="font-bold"></span></li>
                    <li><span class="font-medium">Pump Status:</span> <span id="pump-status" class="font-bold"></span></li>
                    <li><span class="font-medium">Water Flow:</span> <span id="water-flow" class="font-bold"></span></li>
                </ul>
                <button class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out" onclick="controlIrrigation()">
                    Control Irrigation System
                </button>
                 <button class="mt-3 w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out text-sm" onclick="generatePrescriptionMap()">
                    Generate Irrigation Prescription Map
                </button>
            </div>

            <div id="field-operations-card" class="data-card hidden">
                <h3 class="text-2xl font-semibold text-green-800 mb-4">Field Operations & Scouting</h3>
                <p class="text-gray-700 mb-4">Record and manage field observations for better insights.</p>
                <button class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-800 font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out" onclick="recordObservation()">
                    Record New Field Observation
                </button>
                <div class="mt-6">
                    <h4 class="text-lg font-medium text-gray-800 mb-2">Recent Scouting Reports</h4>
                    <ul class="list-disc list-inside text-gray-700 space-y-1" id="scouting-reports">
                        </ul>
                    <p class="text-sm text-gray-500 mt-2" id="no-scouting-data">No recent reports for this farm.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // --- Leaflet Map Initialization ---
        let map = L.map('map').setView([0.5333, 101.4500], 10); // Centered on Pekanbaru, Riau

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- Global variables for NDVI overlay ---
        let ndviOverlayLayer = null;
        let ndviLegend = null;

        // --- Mock Farm Data for Riau ---
        // Coordinates are approximate for demonstration purposes, mimicking SHP/KML boundaries
        const farmData = [
            {
                id: 'farm1',
                name: 'Kebun Sawit Subur',
                location: 'Pelalawan, Riau',
                area: '150 ha',
                geojson: {
                    "type": "Feature",
                    "properties": { "name": "Kebun Sawit Subur", "id": "farm1" },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [101.50, 0.45],
                            [101.55, 0.45],
                            [101.55, 0.50],
                            [101.50, 0.50],
                            [101.50, 0.45] // Close the polygon
                        ]]
                    }
                },
                mockData: {
                    lastUpdate: '2025-06-19 14:00 WIB',
                    ndvi: {
                        labels: ['May 19', 'May 26', 'Jun 2', 'Jun 9', 'Jun 16'],
                        values: [0.75, 0.78, 0.82, 0.79, 0.81]
                    },
                    currentNdmi: '0.55',
                    waterStressStatus: 'Low',
                    currentEvi: '0.68', // Mock EVI
                    soilMoisture: {
                        labels: ['6h ago', '4h ago', '2h ago', 'Now'],
                        values: [40, 38, 45, 52] // Percentage
                    },
                    soilPh: '6.5',
                    airTemp: '30째C',
                    humidity: '85%',
                    last24hRain: '5 mm',
                    weatherForecast: 'Partly cloudy with a chance of light rain tomorrow. Temperature: 28-32째C. Humidity remains high.',
                    irrigationNeeds: 'Moderate (5,000 L/ha)',
                    recommendedAction: 'DSS: Monitor for next 24h. If no rain by tomorrow, initiate 3-hour irrigation cycle.',
                    solarPanelStatus: 'Active (Generating 1.2 kW)',
                    batteryLevel: '80%',
                    pumpStatus: 'Off',
                    waterFlow: '0 L/min',
                    currentPheno: 'Flowering Stage (Oil Palm)',
                    nextPheno: 'Fruiting Stage (Est. 2 weeks)',
                    pestRisk: 'Low',
                    pestAdvice: 'No immediate threats. Maintain regular scouting.',
                    fertRecommendation: 'Next NPK application advised in 3-4 weeks based on soil analysis.',
                    scoutingReports: [
                        { date: '2025-06-10', report: 'Observed healthy growth, no visible pests.' },
                        { date: '2025-05-28', report: 'Minor leaf discoloration in Block C, monitoring.' }
                    ],
                    // Mock NDVI spatial data for this farm (simplified zones)
                    ndviSpatial: {
                        "type": "FeatureCollection",
                        "features": [
                            {
                                "type": "Feature",
                                "properties": { "ndvi_value": 0.65, "zone": "Low Vigor" },
                                "geometry": {
                                    "type": "Polygon",
                                    "coordinates": [[
                                        [101.51, 0.46],
                                        [101.53, 0.46],
                                        [101.53, 0.47],
                                        [101.51, 0.47],
                                        [101.51, 0.46]
                                    ]]
                                }
                            },
                            {
                                "type": "Feature",
                                "properties": { "ndvi_value": 0.75, "zone": "Medium Vigor" },
                                "geometry": {
                                    "type": "Polygon",
                                    "coordinates": [[
                                        [101.52, 0.47],
                                        [101.54, 0.47],
                                        [101.54, 0.49],
                                        [101.52, 0.49],
                                        [101.52, 0.47]
                                    ]]
                                }
                            },
                            {
                                "type": "Feature",
                                "properties": { "ndvi_value": 0.85, "zone": "High Vigor" },
                                "geometry": {
                                    "type": "Polygon",
                                    "coordinates": [[
                                        [101.505, 0.48],
                                        [101.52, 0.48],
                                        [101.52, 0.495],
                                        [101.505, 0.495],
                                        [101.505, 0.48]
                                    ]]
                                }
                            }
                        ]
                    }
                }
            },
            {
                id: 'farm2',
                name: 'Sawah Makmur Jaya',
                location: 'Kampar, Riau',
                area: '80 ha',
                geojson: {
                    "type": "Feature",
                    "properties": { "name": "Sawah Makmur Jaya", "id": "farm2" },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [101.60, 0.60],
                            [101.65, 0.60],
                            [101.65, 0.65],
                            [101.60, 0.65],
                            [101.60, 0.60] // Close the polygon
                        ]]
                    }
                },
                mockData: {
                    lastUpdate: '2025-06-19 13:45 WIB',
                    ndvi: {
                        labels: ['May 19', 'May 26', 'Jun 2', 'Jun 9', 'Jun 16'],
                        values: [0.68, 0.72, 0.70, 0.75, 0.73]
                    },
                    currentNdmi: '0.62',
                    waterStressStatus: 'None',
                    currentEvi: '0.75', // Mock EVI
                    soilMoisture: {
                        labels: ['6h ago', '4h ago', '2h ago', 'Now'],
                        values: [65, 68, 62, 58] // Percentage
                    },
                    soilPh: '6.0',
                    airTemp: '29째C',
                    humidity: '90%',
                    last24hRain: '15 mm',
                    weatherForecast: 'Heavy rain expected tonight, clearing up by midday tomorrow. Temperature: 27-31째C. High humidity will persist.',
                    irrigationNeeds: 'Low (No immediate need)',
                    recommendedAction: 'DSS: No action needed. Monitor soil moisture after heavy rain forecasted tonight.',
                    solarPanelStatus: 'Active (Generating 0.8 kW)',
                    batteryLevel: '95%',
                    pumpStatus: 'Off',
                    waterFlow: '0 L/min',
                    currentPheno: 'Tillering Stage (Rice)',
                    nextPheno: 'Panicle Initiation (Est. 1 week)',
                    pestRisk: 'Medium',
                    pestAdvice: 'Monitor for rice blast. Consider preventive measures if conditions persist.',
                    fertRecommendation: 'Recommended Urea application in 5 days based on growth stage.',
                    scoutingReports: [
                        { date: '2025-06-15', report: 'Healthy crop, good water level in paddy fields.' },
                        { date: '2025-06-01', report: 'Observed few golden apple snails, applied molluscicide.' }
                    ],
                    // Mock NDVI spatial data for this farm
                    ndviSpatial: {
                        "type": "FeatureCollection",
                        "features": [
                            {
                                "type": "Feature",
                                "properties": { "ndvi_value": 0.8, "zone": "High Vigor" },
                                "geometry": {
                                    "type": "Polygon",
                                    "coordinates": [[
                                        [101.605, 0.61],
                                        [101.625, 0.61],
                                        [101.625, 0.63],
                                        [101.605, 0.63],
                                        [101.605, 0.61]
                                    ]]
                                }
                            },
                            {
                                "type": "Feature",
                                "properties": { "ndvi_value": 0.70, "zone": "Medium Vigor" },
                                "geometry": {
                                    "type": "Polygon",
                                    "coordinates": [[
                                        [101.63, 0.62],
                                        [101.645, 0.62],
                                        [101.645, 0.64],
                                        [101.63, 0.64],
                                        [101.63, 0.62]
                                    ]]
                                }
                            }
                        ]
                    }
                }
            }
        ];

        let currentFarmLayer = null; // To store the currently selected farm's Leaflet layer

        // --- Chart.js Instances ---
        let ndviChartInstance = null;
        let soilMoistureChartInstance = null;

        function createChart(canvasId, type, labels, data, labelText, borderColor, backgroundColor) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (Chart.getChart(canvasId)) { // Destroy existing chart instance if it exists
                Chart.getChart(canvasId).destroy();
            }
            return new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: labelText,
                        data: data,
                        borderColor: borderColor,
                        backgroundColor: backgroundColor,
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Important for fixed height container
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // --- Functions to Update Dashboard ---
        function updateDashboard(farm) {
            // Hide placeholder and show data cards
            document.getElementById('data-placeholder').classList.add('hidden');
            document.getElementById('farm-overview-card').classList.remove('hidden');
            document.getElementById('satellite-data-card').classList.remove('hidden');
            document.getElementById('insitu-weather-data-card').classList.remove('hidden');
            document.getElementById('farm-analytics-card').classList.remove('hidden'); // New card
            document.getElementById('irrigation-status-card').classList.remove('hidden');
            document.getElementById('field-operations-card').classList.remove('hidden'); // New card
            document.getElementById('no-farm-selected-overlay').classList.add('hidden');


            // Reset NDVI spatial overlay and legend when selecting a new farm
            removeNdviSpatialLayer();
            document.getElementById('toggle-ndvi-spatial').textContent = 'Show NDVI Map'; // Reset button text

            // Update Farm Overview
            document.getElementById('farm-name').textContent = farm.name;
            document.getElementById('farm-area').textContent = farm.area;
            document.getElementById('farm-location').textContent = farm.location;
            document.getElementById('last-update').textContent = farm.mockData.lastUpdate;

            // Update Satellite Data
            ndviChartInstance = createChart('ndviChart', 'line', farm.mockData.ndvi.labels, farm.mockData.ndvi.values, 'NDVI', '#10B981', 'rgba(16, 185, 129, 0.2)');
            document.getElementById('current-ndmi').textContent = farm.mockData.currentNdmi;
            document.getElementById('water-stress-status').textContent = farm.mockData.waterStressStatus;
            document.getElementById('current-evi').textContent = farm.mockData.currentEvi;

            // Update In-Situ & Weather Data
            soilMoistureChartInstance = createChart('soilMoistureChart', 'line', farm.mockData.soilMoisture.labels, farm.mockData.soilMoisture.values, 'Soil Moisture (%)', '#3B82F6', 'rgba(59, 130, 246, 0.2)');
            document.getElementById('soil-ph').textContent = farm.mockData.soilPh;
            document.getElementById('air-temp').textContent = farm.mockData.airTemp;
            document.getElementById('humidity').textContent = farm.mockData.humidity;
            document.getElementById('last-rain').textContent = farm.mockData.last24hRain;
            document.getElementById('weather-forecast').textContent = farm.mockData.weatherForecast;

            // Update Farm Analytics & Forecasts
            document.getElementById('current-pheno').textContent = farm.mockData.currentPheno;
            document.getElementById('next-pheno').textContent = farm.mockData.nextPheno;
            document.getElementById('pest-risk').textContent = farm.mockData.pestRisk;
            document.getElementById('pest-advice').textContent = farm.mockData.pestAdvice;
            document.getElementById('fert-recommendation').textContent = farm.mockData.fertRecommendation;


            // Update Irrigation & System Status
            document.getElementById('irrigation-needs').textContent = farm.mockData.irrigationNeeds;
            document.getElementById('recommended-action').textContent = farm.mockData.recommendedAction;
            document.getElementById('solar-panel-status').textContent = farm.mockData.solarPanelStatus;
            document.getElementById('battery-level').textContent = farm.mockData.batteryLevel;
            document.getElementById('pump-status').textContent = farm.mockData.pumpStatus;
            document.getElementById('water-flow').textContent = farm.mockData.waterFlow;

            // Update Field Operations & Scouting
            const scoutingReportsList = document.getElementById('scouting-reports');
            scoutingReportsList.innerHTML = ''; // Clear previous reports
            if (farm.mockData.scoutingReports && farm.mockData.scoutingReports.length > 0) {
                document.getElementById('no-scouting-data').classList.add('hidden');
                farm.mockData.scoutingReports.forEach(report => {
                    const li = document.createElement('li');
                    li.textContent = `${report.date}: ${report.report}`;
                    scoutingReportsList.appendChild(li);
                });
            } else {
                document.getElementById('no-scouting-data').classList.remove('hidden');
            }


            // Store current farm for NDVI spatial toggle
            map.currentSelectedFarm = farm;
        }

        // --- NDVI Spatial Overlay Functions ---
        function getColor(d) {
            // Define color scale for NDVI values
            // Darker green for higher vigor, red for lower
            return d > 0.8 ? '#1a9850' : // High vigor (dark green)
                   d > 0.7 ? '#66bd63' : // Medium-high vigor (light green)
                   d > 0.6 ? '#a6d96a' : // Medium vigor (yellow-green)
                   d > 0.5 ? '#fdae61' : // Medium-low vigor (light orange)
                   d > 0.4 ? '#f46d43' : // Low vigor (orange)
                             '#d73027'; // Very low vigor (red)
        }

        function styleNdvi(feature) {
            return {
                fillColor: getColor(feature.properties.ndvi_value),
                weight: 0, // No border for heatmap effect
                opacity: 0, // No border opacity
                color: 'white',
                fillOpacity: 0.7
            };
        }

        function addNdviSpatialLayer(farm) {
            if (ndviOverlayLayer) {
                map.removeLayer(ndviOverlayLayer);
            }
            if (farm && farm.mockData.ndviSpatial) {
                ndviOverlayLayer = L.geoJSON(farm.mockData.ndviSpatial, {
                    style: styleNdvi,
                    // No onEachFeature needed as popups are not for individual NDVI zones
                }).addTo(map);

                // Add NDVI Legend
                if (!ndviLegend) {
                    ndviLegend = L.control({ position: 'bottomright' });
                    ndviLegend.onAdd = function (map) {
                        var div = L.DomUtil.create('div', 'info legend');
                        var grades = [0.4, 0.5, 0.6, 0.7, 0.8]; // Example NDVI thresholds
                        var labels = [];
                        div.innerHTML += '<b>NDVI Vigor</b><br>';
                        // loop through our density intervals and generate a label with a colored square for each interval
                        for (var i = 0; i < grades.length; i++) {
                            div.innerHTML +=
                                '<i style="background:' + getColor(grades[i] + 0.01) + '"></i> ' +
                                grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] : '+') + '<br>';
                        }
                        return div;
                    };
                    ndviLegend.addTo(map);
                } else {
                    ndviLegend.addTo(map); // Re-add if it was removed
                }
            }
        }

        function removeNdviSpatialLayer() {
            if (ndviOverlayLayer) {
                map.removeLayer(ndviOverlayLayer);
                ndviOverlayLayer = null;
            }
            if (ndviLegend) {
                map.removeControl(ndviLegend);
            }
        }

        // --- Map & Farm List Population ---
        const farmListElement = document.getElementById('farm-list');

        farmData.forEach(farm => {
            // Add farm to map
            const geojsonLayer = L.geoJSON(farm.geojson, {
                style: function (feature) {
                    return {
                        color: "#3B82F6", // Blue
                        weight: 2,
                        opacity: 0.8,
                        fillColor: "#BFDBFE", // Light blue
                        fillOpacity: 0.5
                    };
                },
                onEachFeature: function (feature, layer) {
                    layer.bindPopup(`<b>${farm.name}</b><br>${farm.area}<br>${farm.location}`);
                    layer.on('click', function() {
                        if (currentFarmLayer) {
                            currentFarmLayer.setStyle({ fillColor: "#BFDBFE" }); // Reset previous
                        }
                        layer.setStyle({ fillColor: "#10B981" }); // Highlight selected (green)
                        currentFarmLayer = layer;
                        updateDashboard(farm);
                        map.fitBounds(layer.getBounds()); // Zoom to selected farm
                    });
                }
            }).addTo(map);

            // Add farm to sidebar list
            const listItem = document.createElement('li');
            listItem.className = 'cursor-pointer p-3 rounded-md hover:bg-gray-50 transition duration-150 ease-in-out text-gray-700 font-medium';
            listItem.textContent = farm.name;
            listItem.onclick = () => {
                // Simulate click on map layer
                geojsonLayer.fire('click');
            };
            farmListElement.appendChild(listItem);
        });

        // --- Initial State (No farm selected) ---
        // Display placeholder and overlay for map
        document.getElementById('data-placeholder').classList.remove('hidden');
        document.getElementById('farm-overview-card').classList.add('hidden');
        document.getElementById('satellite-data-card').classList.add('hidden');
        document.getElementById('insitu-weather-data-card').classList.add('hidden');
        document.getElementById('farm-analytics-card').classList.add('hidden'); // Hide new card initially
        document.getElementById('irrigation-status-card').classList.add('hidden');
        document.getElementById('field-operations-card').classList.add('hidden'); // Hide new card initially
        document.getElementById('no-farm-selected-overlay').classList.remove('hidden');

        // --- Toggle NDVI Spatial Layer ---
        document.getElementById('toggle-ndvi-spatial').addEventListener('click', function() {
            if (map.currentSelectedFarm) {
                if (ndviOverlayLayer) {
                    removeNdviSpatialLayer();
                    this.textContent = 'Show NDVI Map';
                } else {
                    addNdviSpatialLayer(map.currentSelectedFarm);
                    this.textContent = 'Hide NDVI Map';
                }
            } else {
                alert('Please select a farm area first to view NDVI spatial data.');
            }
        });

        // --- Mock Action Functions (for buttons) ---
        function controlIrrigation() {
            alert('Initiating irrigation sequence based on DSS recommendations! (Mock Action)');
            // In a real app, this would send command to IoT device.
        }

        function generatePrescriptionMap() {
            alert('Generating variable rate irrigation prescription map... (Mock Action)');
            // In a real app, this would generate a downloadable/uploadable map for VRA.
        }

        function recordObservation() {
            alert('Opening field observation form... (Mock Action - Crop Scouting)');
            // In a real app, this would open a modal or navigate to a form.
        }
    </script>
</body>
</html>
